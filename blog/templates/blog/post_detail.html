{% extends 'base.html' %}
{% block content %}

<a href="{% url 'blog:post_list' %}">–ù–∞–∑–∞–¥ –∫ –ø–æ—Å—Ç–∞–º</a>
<div class="post-detail">
    <h1 class="post-detail__h1">{{post.title}}</h1>
    {% if post.image %}
                <img src="{{ post.image.url }}" alt="{{ post.title }}" style="max-width: 300px;">
            {% endif %}
    <p class="post-detail__text">
        {{post.body|linebreaks}}
    </p>

     <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ post.author.username }}</p>
    <p><strong>–î–∞—Ç–∞:</strong> {{ post.created|date:"d.m.Y H:i" }}</p>
</div>
{% if user.is_authenticated %}
<p>–ü–æ–Ω—Ä–∞–≤–∏–ª—Å—è –ø–æ—Å—Ç? –ü–æ—Å—Ç–∞–≤—å –ª–∞–π–∫ üëá</p>
<!-- –Ω–æ–≤–æ–µ 09 01 -->
 <!--  -->
 <!-- <form action="{% url 'blog:like_post' post.slug %}" id="like-post-form" data-url="{% url 'blog:like_post' post.slug %}">
        {% csrf_token %}
        <button type="submit">
            ‚ù§Ô∏è 
            <span>{{post.likes.count}}</span>
        </button>
</form>  -->
<!-- –ò–∑–º–µ–Ω–∏—Ç–µ —ç—Ç–æ—Ç –±–ª–æ–∫: -->
<form action="{% url 'blog:like_post' post.slug %}" id="like-post-form" data-url="{% url 'blog:like_post' post.slug %}">
    {% csrf_token %}
    <button type="submit">
        ‚ù§Ô∏è 
        <span id="post-likes-count">{{post.likes.count}}</span>  <!-- –î–æ–±–∞–≤–∏–ª–∏ id -->
    </button>
</form>
<h3>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: {{post.comments.count}}</h3>

<!-- –ë–æ–Ω—É—Å: –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ª–∞–π–∫–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
<form method="post">
    {% csrf_token %}
    <textarea name="body" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
    </textarea>
    <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
</form>
{% else %}
<p>–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã —Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫–∏ –∏ –æ—Å—Ç–∞–≤–ª—è—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</p>
{% endif %}
{% for comment in post.comments.all %}
{% if comment.active %}
<div class="comment">
    <!-- –í–∏–¥–Ω—ã —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è -->
     {% if comment.author.profile.avatar %}
        <img src="{{comment.author.profile.avatar.url}}" alt="avatar" width="40">
     {% endif%}
    <!--  –î–æ–±–∞–≤–∏—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–∑–º–µ–Ω–∏—Ç—å —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π 
     –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è , –Ω–µ —Å—Ä–∞–∑—É –ø—É–±–ª–∏–∫–∞—Ü–∏—è, –∞ –º–æ–¥–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–¥–æ–±—Ä—è—Ç—å -->
<h4>{{comment.author.username}}</h4>
<p>{{comment.created}}</p>
<p>{{comment.body|linebreaks}}</p>

{% if user.is_authenticated and user != comment.author %}
    <!-- <form action="{% url 'blog:like_comment' comment.id %}" method="post"> -->
        <!-- <form class="like-comment-form" data-url="{% url 'blog:like_comment' comment.id %}">
        {% csrf_token %}
        <button type="submit">
            ‚ù§Ô∏è {{ comment.likes.count }}
        </button>
    </form> -->
    <!-- –Ω–æ–≤–æ–µ 09 01 -->

<form class="like-comment-form" data-url="{% url 'blog:like_comment' comment.id %}">
    {% csrf_token %}
    <button type="submit">
        ‚ù§Ô∏è <span class="comment-likes">{{ comment.likes.count }}</span>
    </button>
</form>

    {% endif %}

{% if user == comment.author %}
    <a href="{% url 'blog:delete_comment' comment.id %}" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')">
        –£–¥–∞–ª–∏—Ç—å</a>
{% endif %}

</div>
{% endif %}
{% empty %}
<p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å –ø–µ—Ä–≤—ã–º!</p>
{% endfor %}

<script>
    
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('like-post-form')
        // 2 —Å–ø–æ—Å–æ–±
        // const form = document.querySelector('#like-post-form')
        if (form) {
            form.addEventListener('submit', function (e) {
                e.preventDefault() 
                const csrfToken = form.querySelector('[name="csrfmiddlewaretoken"]').value
                fetch(form.dataset.url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest' 
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok')
                    }
                    return response.json()
                })
                .then(data => {
                    const likesCount = document.getElementById("post-likes-count")
                    if (likesCount) {
                        likesCount.textContent = data.likes_count; 
                    }
                    const button = form.querySelector('button')
                    if (data.liked) {
                        button.style.color = 'red'
                    }
                    else {
                        button.style.color = 'gray'
                    }
                })
                .catch(error => {
                    console.log('Error:', error)
                    form.submit()
                })
            })
        }
    document.querySelectorAll('.like-comment-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            fetch(form.dataset.url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name="csrfmiddlewaretoken"]').value,
                    'X-Requested-With': 'XMLHttpRequest' 
                }
            }).then(res=>res.json())
            .then(data => {
                form.querySelector('.comment-likes').textContent = data.likes_count
            })
        })
    })
    
    })
</script>









<!-- –Ω–æ–≤–æ–µ 09 01 -->
<!-- <script>
document.addEventListener('DOMContentLoaded', function () {

    // ‚ù§Ô∏è –õ–ê–ô–ö –ü–û–°–¢–ê
    const postForm = document.getElementById('like-post-form');
    if (postForm) {
        postForm.addEventListener('submit', function (e) {
            e.preventDefault();

            fetch(postForm.dataset.url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': postForm.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('post-likes-count').textContent = data.likes_count;
            });
        });
    }

    // ‚ù§Ô∏è –õ–ê–ô–ö –ö–û–ú–ú–ï–ù–¢–ê–†–ò–Ø
    document.querySelectorAll('.like-comment-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();

            fetch(form.dataset.url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(res => res.json())
            .then(data => {
                form.querySelector('.comment-likes').textContent = data.likes_count;
            });
        });
    });

});
</script> -->


{% endblock %}